---
// Education component - Final Robust Fix
// Layout: S-Curve with explicit routing around text
// Animation: Using CDN anime.js for reliability
import { getCollection } from "astro:content";

const educationEntries = await getCollection("education");
const sortedEducation = [...educationEntries].sort(
  (a, b) => (a.data.order as number) - (b.data.order as number),
);
---

<section class="section education" id="education">
  <div class="container">
    <h2 class="section-title">Education</h2>

    <div class="education-journey">
      <!-- SVG Layer -->
      <svg
        class="flight-path-svg"
        viewBox="0 0 1000 700"
        preserveAspectRatio="xMidYMid meet"
      >
        <!-- 
            Path Strategy:
            1. Oxford (50, 600) -> Christ (950, 350)
               - Oxford Text is to the RIGHT of marker (x=100+).
               - Path starts at 50, 600. 
               - Dip DOWN to y=680 to go under the text.
               - Curve up to Christ (950, 350).
               - Christ Text is to the LEFT of marker (x=...900).
               - Path approaches 950, 350 from BELOW to avoid text?
            
            2. Christ (950, 350) -> BNMIT (50, 100)
               - BNMIT Text is to the RIGHT of marker (x=100+).
               - Path arrives at 50, 100.
               - Path must come from ABOVE to avoid crossing text to the right.
               - So from Christ, curve Up high (y=20), then drop to 50, 100.
         -->
        <path
          class="flight-line"
          id="education-path"
          d="M 50 600
             Q 50 680, 200 680
             T 600 550
             T 950 350
             Q 800 50, 400 50
             T 50 100"
          fill="none"
          stroke="rgba(255, 255, 255, 0.3)"
          stroke-width="2"
          stroke-dasharray="8 8"
          stroke-linecap="round"></path>

        <!-- Airplane Icon -->
        <g id="airplane" style="display: none;">
          <!-- Hidden vertically until script runs -->
          <!-- Simple Plane Shape pointing RIGHT -->
          <path
            d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z"
            fill="white"
            transform="scale(1.8) rotate(90 12 12)"></path>
        </g>
      </svg>

      <!-- Content Layer -->

      <!-- 1. BNMIT (Top Left) -->
      <div class="edu-entry edu-bnmit">
        <div class="marker-wrapper">
          <svg
            class="location-marker current"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <path d="M12 21c-4-4-8-7.5-8-12a8 8 0 1 1 16 0c0 4.5-4 8-8 12z"
            ></path>
            <circle cx="12" cy="9" r="3"></circle>
          </svg>
        </div>
        <div class="edu-info">
          <h3 class="edu-title">
            {sortedEducation[0]?.data.institution}
            <span class="edu-location"
              >({sortedEducation[0]?.data.location})</span
            >
          </h3>
          <p class="edu-degree">{sortedEducation[0]?.data.degree}</p>
          <p class="edu-score">{sortedEducation[0]?.data.score}</p>
        </div>
      </div>

      <!-- 2. Christ Junior (Middle Right) -->
      <div class="edu-entry edu-christ">
        <div class="edu-info align-right">
          <h3 class="edu-title">
            {sortedEducation[1]?.data.institution}
            <span class="edu-location"
              >({sortedEducation[1]?.data.location})</span
            >
          </h3>
          <p class="edu-degree">{sortedEducation[1]?.data.degree}</p>
          <p class="edu-score">{sortedEducation[1]?.data.score}</p>
        </div>
        <div class="marker-wrapper">
          <svg
            class="location-marker"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <path d="M12 21c-4-4-8-7.5-8-12a8 8 0 1 1 16 0c0 4.5-4 8-8 12z"
            ></path>
            <circle cx="12" cy="9" r="3"></circle>
          </svg>
        </div>
      </div>

      <!-- 3. Oxford (Bottom Left) -->
      <div class="edu-entry edu-oxford">
        <div class="marker-wrapper">
          <svg
            class="location-marker"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <path d="M12 21c-4-4-8-7.5-8-12a8 8 0 1 1 16 0c0 4.5-4 8-8 12z"
            ></path>
            <circle cx="12" cy="9" r="3"></circle>
          </svg>
        </div>
        <div class="edu-info">
          <h3 class="edu-title">
            {sortedEducation[2]?.data.institution}
            <span class="edu-location"
              >({sortedEducation[2]?.data.location})</span
            >
          </h3>
          <p class="edu-degree">{sortedEducation[2]?.data.degree}</p>
          <p class="edu-score">{sortedEducation[2]?.data.score}</p>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Load anime.js from CDN for guaranteed functionality -->
<script
  is:inline
  src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"
></script>

<script is:inline>
  document.addEventListener("DOMContentLoaded", () => {
    const path = document.getElementById("education-path");
    const airplane = document.getElementById("airplane");

    // Safety check
    if (!path || !airplane || typeof anime === "undefined") {
      console.error("Education Animation: Elements or anime.js not found");
      if (airplane) airplane.style.display = "block"; // Fallback
      return;
    }

    // Show plane
    airplane.style.display = "block";

    // Create motion path
    const motionPath = anime.path("#education-path");

    anime({
      targets: "#airplane",
      translateX: motionPath("x"),
      translateY: motionPath("y"),
      rotate: motionPath("angle"),
      easing: "linear",
      duration: 12000,
      loop: true,
    });
  });
</script>

<style>
  .education {
    background: var(--bg-primary);
    overflow: visible;
  }

  .education-journey {
    position: relative;
    height: 700px;
    max-width: 1000px;
    margin: 0 auto;
    margin-top: var(--space-xl);
  }

  .flight-path-svg {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 5; /* Visible but controllable */
    pointer-events: none;
  }

  /* Entries */
  .edu-entry {
    position: absolute;
    z-index: 10;
    display: flex;
    align-items: flex-start;
    gap: 20px;
  }

  .marker-wrapper {
    flex-shrink: 0;
    width: 40px;
    height: 40px;
    display: flex;
    justify-content: center;
    background: var(--bg-primary);
    border-radius: 50%;
    z-index: 20;
  }

  /* 
     Positions matching SVG Coords
     BNMIT: 50, 100
     Christ: 950, 350
     Oxford: 50, 600
     Offset -20 for center
  */

  .edu-bnmit {
    top: 80px;
    left: 30px;
  }

  .edu-christ {
    top: 330px;
    right: 30px;
  }

  .edu-oxford {
    top: 580px;
    left: 30px;
  }

  .location-marker {
    width: 40px;
    height: 40px;
    color: white;
    filter: drop-shadow(0 0 8px rgba(0, 0, 0, 0.8));
    fill: var(--bg-primary);
  }

  .location-marker.current {
    color: var(--accent-primary);
  }

  /* Info */
  .edu-info {
    max-width: 400px;
    padding-top: 5px;
  }

  .edu-info.align-right {
    text-align: right;
  }

  .edu-title {
    font-family: var(--font-serif);
    font-size: 1.8rem;
    font-weight: 500;
    color: var(--text-primary);
    margin-bottom: 5px;
    line-height: 1.25;
  }

  .edu-location {
    font-size: 1rem;
    color: var(--gray-400);
    font-weight: 300;
  }

  .edu-degree {
    font-size: 1.2rem;
    color: var(--text-secondary);
    margin-bottom: 4px;
    font-weight: 300;
  }

  .edu-score {
    font-size: 1.15rem;
    color: var(--accent-primary);
    font-weight: 600;
  }

  @media (max-width: 900px) {
    .education-journey {
      height: auto;
      display: flex;
      flex-direction: column;
      gap: 60px;
      padding: 40px 20px;
    }

    .flight-path-svg {
      display: none;
    }

    .edu-entry {
      position: static;
    }

    .edu-christ {
      flex-direction: row-reverse;
      align-self: flex-end;
    }

    .edu-christ .edu-info {
      text-align: right;
    }
  }
</style>
