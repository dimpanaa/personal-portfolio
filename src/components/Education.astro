---
// Education component with animated flight path using anime.js
// Path flows from bottom (High School) to top (Current - BNMIT)
import { getCollection } from "astro:content";

// Fetch education entries from content collection, sorted by order
const educationEntries = await getCollection("education");
const sortedEducation = [...educationEntries].sort(
  (a, b) => (a.data.order as number) - (b.data.order as number),
);

// Helper function to get stop class based on index
const getStopClass = (index: number) => {
  const classes = ["stop-1", "stop-2", "stop-3"];
  return classes[index] || "stop-3";
};
---

<section class="section education" id="education">
  <div class="container">
    <h2 class="section-title">Education</h2>

    <div class="education-journey">
      <!-- SVG Flight Path -->
      <svg
        class="flight-path-svg"
        viewBox="0 0 800 600"
        preserveAspectRatio="xMidYMid meet"
      >
        <!-- Main curved path - Bottom to Top -->
        <path
          class="flight-line"
          id="education-path"
          d="M 100 520
             Q 100 480, 150 480
             L 350 480
             Q 400 480, 400 430
             Q 400 380, 450 380
             L 650 380
             Q 700 380, 700 330
             Q 700 280, 650 280
             L 450 280
             Q 400 280, 400 230
             Q 400 180, 350 180
             L 150 180
             Q 100 180, 100 130
             L 100 80"
          fill="none"
          stroke="var(--accent-primary)"
          stroke-width="3"
          stroke-dasharray="10 5"
          stroke-linecap="round"></path>

        <!-- Airplane that follows the path -->
        <text
          class="airplane-icon"
          id="airplane"
          font-size="28"
          text-anchor="middle"
          dominant-baseline="middle">‚úà</text
        >
      </svg>

      <!-- Education Cards positioned along the path -->
      <div class="edu-stops">
        {
          sortedEducation.map((edu, index) => {
            const stopClass = getStopClass(index);
            const isMiddle = index === 1; // stop-2 has reversed order (card before pin)
            const yearDisplay =
              edu.data.startYear === edu.data.endYear
                ? edu.data.startYear
                : `${edu.data.startYear} - ${edu.data.endYear}`;

            return (
              <div class={`edu-stop ${stopClass}`}>
                {!isMiddle && <div class="edu-pin-marker">üìç</div>}
                <div class={`edu-card ${edu.data.isCurrent ? "current" : ""}`}>
                  <h3>
                    {edu.data.institution}{" "}
                    <span class="edu-location">({edu.data.location})</span>
                  </h3>
                  <p class="edu-degree">{edu.data.degree}</p>
                  <p class="edu-score">{edu.data.score}</p>
                  <span class="edu-year">{yearDisplay}</span>
                </div>
                {isMiddle && <div class="edu-pin-marker">üìç</div>}
              </div>
            );
          })
        }
      </div>
    </div>
  </div>
</section>

<script>
  // Animation using native anime.js motion path
  import { animate, svg } from "animejs";

  const initAnimation = () => {
    const path = document.getElementById("education-path");
    const airplane = document.getElementById("airplane");

    if (!path || !airplane) return;

    // Get path length for proper animation
    const pathLength = path.getTotalLength();

    // Set initial dash state (hidden)
    path.style.strokeDasharray = pathLength;
    path.style.strokeDashoffset = pathLength;

    // Use anime.js motion path
    const motionPath = svg.createMotionPath("#education-path");

    // Animate airplane along the path
    animate("#airplane", {
      ...motionPath,
      duration: 6000,
      ease: "linear",
      loop: true,
    });

    // Draw the path line
    animate("#education-path", {
      strokeDashoffset: [pathLength, 0],
      duration: 6000,
      ease: "linear",
      loop: true,
    });
  };

  // Initialize on DOM ready
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initAnimation);
  } else {
    initAnimation();
  }
</script>

<style>
  .education-journey {
    position: relative;
    min-height: 600px;
    max-width: 900px;
    margin: 0 auto;
  }

  .flight-path-svg {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 0;
    pointer-events: none;
  }

  .flight-line {
    opacity: 0.8;
  }

  .airplane-icon {
    fill: var(--text-primary);
  }

  /* Education stops container */
  .edu-stops {
    position: relative;
    z-index: 1;
    display: flex;
    flex-direction: column;
    gap: var(--space-xl);
    padding: var(--space-xl) 0;
    min-height: 550px;
    justify-content: space-between;
  }

  .edu-stop {
    display: flex;
    align-items: flex-start;
    gap: var(--space-md);
  }

  /* Position stops to align with path - reversed order */
  .stop-3 {
    /* Oxford - Bottom left */
    align-self: flex-start;
    margin-left: 5%;
    order: 3;
  }

  .stop-2 {
    /* Christ - Middle right */
    align-self: flex-end;
    margin-right: 5%;
    flex-direction: row-reverse;
    order: 2;
  }

  .stop-1 {
    /* BNMIT - Top left */
    align-self: flex-start;
    margin-left: 5%;
    order: 1;
  }

  .edu-pin-marker {
    font-size: 2rem;
    flex-shrink: 0;
    animation: bounce 2s ease-in-out infinite;
  }

  @keyframes bounce {
    0%,
    100% {
      transform: translateY(0);
    }
    50% {
      transform: translateY(-5px);
    }
  }

  .edu-card {
    background: rgba(255, 255, 255, 0.03);
    backdrop-filter: blur(10px);
    padding: var(--space-lg);
    border-radius: var(--radius-md);
    border: 1px solid var(--gray-700);
    max-width: 380px;
    transition: all var(--transition-normal);
  }

  .edu-card.current {
    border-color: var(--accent-primary);
    box-shadow: 0 0 20px rgba(255, 75, 75, 0.15);
  }

  .edu-card:hover {
    border-color: var(--accent-primary);
    transform: translateY(-3px);
    box-shadow: 0 10px 30px rgba(255, 75, 75, 0.1);
  }

  .edu-card h3 {
    font-family: var(--font-sans);
    font-size: 1.15rem;
    font-weight: 600;
    margin-bottom: var(--space-sm);
    color: var(--text-primary);
  }

  .edu-location {
    color: var(--gray-400);
    font-weight: 400;
    font-size: 0.9rem;
  }

  .edu-degree {
    font-size: 0.95rem;
    color: var(--text-secondary);
    margin-bottom: var(--space-xs);
  }

  .edu-score {
    font-size: 0.95rem;
    color: var(--accent-primary);
    font-weight: 500;
  }

  .edu-year {
    display: inline-block;
    margin-top: var(--space-sm);
    padding: var(--space-xs) var(--space-sm);
    background: var(--bg-tertiary);
    border-radius: var(--radius-sm);
    font-size: 0.8rem;
    color: var(--gray-400);
  }

  /* Responsive */
  @media (max-width: 768px) {
    .education-journey {
      min-height: auto;
    }

    .flight-path-svg {
      display: none;
    }

    .edu-stops {
      min-height: auto;
      gap: var(--space-lg);
    }

    .edu-stop {
      align-self: stretch !important;
      margin: 0 !important;
      flex-direction: row !important;
    }

    .stop-1 {
      order: 1;
    }
    .stop-2 {
      order: 2;
    }
    .stop-3 {
      order: 3;
    }

    .edu-card {
      max-width: 100%;
      flex: 1;
    }
  }
</style>
